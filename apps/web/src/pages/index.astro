---
import BaseLayout from '../layouts/BaseLayout.astro';
import PrivacyRibbon from '../components/PrivacyRibbon.astro';
import SlotTabs from '../components/SlotTabs.svelte';
import VersatilityRanking from '../components/VersatilityRanking.astro';
import { getVersatilityRanking } from '../lib/queries';
import { SLOT_IDS, getQueryVersion, getAvailableVersions } from '../lib/db';

// クエリパラメータからスロットとバージョンを取得
const url = new URL(Astro.request.url);
const slotParam = url.searchParams.get('slot') ?? 'body';
const versionParam = url.searchParams.get('version');
const currentSlot = slotParam as keyof typeof SLOT_IDS;
const slotId = SLOT_IDS[currentSlot] ?? 2;

// D1からデータ取得
const db = Astro.locals.runtime.env.DB;
let items: Awaited<ReturnType<typeof getVersatilityRanking>> = [];
let versions: Awaited<ReturnType<typeof getAvailableVersions>> = [];
let currentVersion = '';

try {
  // バージョン一覧を取得し、リクエストされたバージョンを検証
  versions = await getAvailableVersions(db);
  currentVersion = await getQueryVersion(db, versionParam);

  // 指定バージョンでデータ取得
  items = await getVersatilityRanking(db, slotId, 10, currentVersion);
} catch (e) {
  console.error('D1 query error:', e);
}
---

<BaseLayout title={`ミラプリインサイト`} versions={versions} currentVersion={currentVersion}>
  <PrivacyRibbon slot="ribbon" />

  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-bold">人気ランキング</h1>
      <p class="mt-1 text-sm text-muted-foreground">
        多くの装備とベストマッチになっている人気アイテム
      </p>
    </div>

    <SlotTabs currentSlot={currentSlot} client:load />

    <VersatilityRanking items={items} />
  </div>
</BaseLayout>
