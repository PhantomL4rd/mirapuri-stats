---
import BaseLayout from '../layouts/BaseLayout.astro';
import PrivacyRibbon from '../components/PrivacyRibbon.astro';
import SlotTabs from '../components/SlotTabs.svelte';
import VersatilityRanking from '../components/VersatilityRanking.astro';
import { getVersatilityRanking, getDataFreshness } from '../lib/queries';
import { SLOT_IDS } from '../lib/db';

// クエリパラメータからスロットを取得（デフォルト: body = 胴）
const url = new URL(Astro.request.url);
const slotParam = url.searchParams.get('slot') ?? 'body';
const currentSlot = slotParam as keyof typeof SLOT_IDS;
const slotId = SLOT_IDS[currentSlot] ?? 2;

// D1からデータ取得
const db = Astro.locals.runtime.env.DB;
let items: Awaited<ReturnType<typeof getVersatilityRanking>> = [];
let freshness: Awaited<ReturnType<typeof getDataFreshness>> = { dataFrom: null, dataTo: null };

try {
  [items, freshness] = await Promise.all([
    getVersatilityRanking(db, slotId, 20),
    getDataFreshness(db),
  ]);
} catch (e) {
  console.error('D1 query error:', e);
}
---

<BaseLayout title={`ミラプリインサイト`} freshness={freshness}>
  <PrivacyRibbon slot="ribbon" />

  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-bold">着回し力ランキング</h1>
      <p class="mt-1 text-sm text-muted-foreground">
        多くの装備とベストマッチになっている万能選手
      </p>
    </div>

    <SlotTabs currentSlot={currentSlot} client:load />

    <VersatilityRanking items={items} />
  </div>
</BaseLayout>
