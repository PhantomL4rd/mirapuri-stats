---
import BaseLayout from '../layouts/BaseLayout.astro';
import PrivacyRibbon from '../components/PrivacyRibbon.astro';
import SlotTabs from '../components/SlotTabs.svelte';
import VersatilityRanking from '../components/VersatilityRanking.astro';
import { getVersatilityRanking, getDataFreshness } from '../lib/queries';
import { SLOT_NAMES } from '../lib/db';

// クエリパラメータからスロットIDを取得（デフォルト: 2 = 胴）
const url = new URL(Astro.request.url);
const slotParam = url.searchParams.get('slot');
const currentSlot = slotParam ? parseInt(slotParam, 10) : 2;

// D1からデータ取得
const db = Astro.locals.runtime.env.DB;
let items: Awaited<ReturnType<typeof getVersatilityRanking>> = [];
let freshness: Awaited<ReturnType<typeof getDataFreshness>> = { dataFrom: null, dataTo: null };

try {
  [items, freshness] = await Promise.all([
    getVersatilityRanking(db, currentSlot, 20),
    getDataFreshness(db),
  ]);
} catch (e) {
  console.error('D1 query error:', e);
}

// 日付フォーマット
function formatDate(dateStr: string | null): string {
  if (!dateStr) return '不明';
  const date = new Date(dateStr);
  return `${date.getMonth() + 1}月${date.getDate()}日`;
}

const slotName = SLOT_NAMES[currentSlot] ?? '装備';
---

<BaseLayout title={`${slotName}の着回し力ランキング | ミラプリパルス`}>
  <PrivacyRibbon slot="ribbon" />

  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-bold">着回し力ランキング</h1>
      <p class="mt-1 text-sm text-muted-foreground">
        多くの装備とペアになっている「万能選手」を表示しています
      </p>
      {
        freshness.dataFrom && freshness.dataTo && (
          <p class="mt-1 text-xs text-muted-foreground">
            {formatDate(freshness.dataFrom)} - {formatDate(freshness.dataTo)} 時点のデータ
          </p>
        )
      }
    </div>

    <SlotTabs currentSlot={currentSlot} client:load />

    <VersatilityRanking items={items} />
  </div>
</BaseLayout>
