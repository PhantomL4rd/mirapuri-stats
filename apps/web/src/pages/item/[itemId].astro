---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PrivacyRibbon from '../../components/PrivacyRibbon.astro';
import { ArrowLeft } from 'lucide-svelte';
import { getItemInfo, getPartnerItems, getDataFreshness } from '../../lib/queries';
import { SLOT_NAMES } from '../../lib/db';

const { itemId } = Astro.params;

if (!itemId) {
  return Astro.redirect('/');
}

const db = Astro.locals.runtime.env.DB;

const [itemInfo, partnerItems, freshness] = await Promise.all([
  getItemInfo(db, itemId),
  getPartnerItems(db, itemId, 10),
  getDataFreshness(db),
]);

if (!itemInfo) {
  return Astro.redirect('/');
}

const slotName = SLOT_NAMES[itemInfo.slotId] ?? '装備';

// 部位ごとにグループ化
const partnersBySlot = partnerItems.reduce(
  (acc, item) => {
    const slot = item.slotId;
    if (!acc[slot]) acc[slot] = [];
    acc[slot].push(item);
    return acc;
  },
  {} as Record<number, typeof partnerItems>,
);

// 表示順: 頭(1), 胴(2), 手(3), 脚(4), 足(5) - ただし自分の部位は除外
const slotOrder = [1, 2, 3, 4, 5].filter((s) => s !== itemInfo.slotId);

function getLodestoneUrl(id: string): string {
  return `https://jp.finalfantasyxiv.com/lodestone/playguide/db/item/${id}/`;
}
---

<BaseLayout title={`${itemInfo.itemName}のベストマッチ | ミラプリインサイト`} freshness={freshness}>
  <PrivacyRibbon slot="ribbon" />

  <div class="space-y-6">
    <div>
      <p class="text-sm text-muted-foreground">{slotName}</p>
      <h1 class="text-2xl font-bold">
        <a
          id="item-title"
          href={getLodestoneUrl(itemInfo.itemId)}
          class="eorzeadb_link cursor-help"
        >
          {itemInfo.itemName}
        </a>
      </h1>
      <p class="mt-1 text-sm text-muted-foreground">のベストマッチ</p>
    </div>

    <div class="space-y-3">
      {
        partnerItems.length === 0 ? (
          <p class="text-center text-muted-foreground py-8">データがありません</p>
        ) : itemInfo.slotId === 2 || itemInfo.slotId === 4 ? (
          // 胴・脚装備: 部位ごとにアコーディオン（複数部位とペアがあるため）
          slotOrder.map((slotId) => {
            const items = partnersBySlot[slotId];
            if (!items || items.length === 0) return null;
            const slotLabel = SLOT_NAMES[slotId] ?? '装備';
            return (
              <details class="group rounded-lg border border-border bg-card shadow-sm" open>
                <summary class="flex cursor-pointer items-center justify-between p-3 font-medium text-card-foreground hover:bg-muted/50">
                  <span>{slotLabel}</span>
                </summary>
                <ul class="border-t border-border">
                  {items.map((item) => (
                    <li class="flex items-center gap-3 border-b border-border last:border-b-0 p-3">
                      <a
                        href={`/item/${item.itemId}`}
                        class="flex-1 font-medium text-card-foreground hover:underline inline-flex items-center gap-1"
                      >
                        {item.itemName}
                      </a>
                      <a
                        href={getLodestoneUrl(item.itemId)}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="eorzeadb_link text-xs text-muted-foreground hover:text-foreground"
                      >
                        Lodestone
                      </a>
                    </li>
                  ))}
                </ul>
              </details>
            );
          })
        ) : (
          // 頭・手・足: フラットリスト（単一部位とのペアのみ）
          <ul class="space-y-2">
            {partnerItems.map((item) => (
              <li class="flex items-center gap-3 rounded-lg border border-border bg-card p-3 shadow-sm">
                <a
                  href={`/item/${item.itemId}`}
                  class="flex-1 font-medium text-card-foreground hover:underline inline-flex items-center gap-1"
                >
                  {item.itemName}
                </a>
                <a
                  href={getLodestoneUrl(item.itemId)}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="eorzeadb_link text-xs text-muted-foreground hover:text-foreground"
                >
                  Lodestone
                </a>
              </li>
            ))}
          </ul>
        )
      }
    </div>

    <div class="pt-4">
      <a href="/" class="text-sm text-muted-foreground hover:underline inline-flex items-center gap-1">
        <ArrowLeft class="size-4" />
        ランキングに戻る
      </a>
    </div>
  </div>

  <script>
    const link = document.getElementById('item-title');
    let tooltipVisible = false;

    link?.addEventListener('click', (e) => {
      e.preventDefault();

      // Lodestoneスクリプトが読み込んだjQueryを使う
      const $ = (window as any).jQuery;
      if (!$) {
        console.log('jQuery not loaded');
        return;
      }

      const edb = (window as any).eorzeadb;
      console.log('eorzeadb:', edb);
      console.log('tooltipVisible:', tooltipVisible);

      if (!tooltipVisible) {
        // jQueryのtriggerでmouseenterを発火
        $(link).trigger('mouseenter');
        tooltipVisible = true;
      } else {
        $(link).trigger('mouseleave');
        tooltipVisible = false;
      }
    });
  </script>
</BaseLayout>
