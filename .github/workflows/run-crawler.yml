name: Run Crawler

on:
  workflow_dispatch: # Manual trigger only

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  APP_NAME: mirapri-stats
  FLY_API_HOSTNAME: https://api.machines.dev

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: latest

      - name: Build and push image
        id: build
        run: |
          OUTPUT=$(flyctl deploy --build-only --push \
            --app $APP_NAME \
            --dockerfile apps/scraper/Dockerfile \
            --config apps/scraper/fly.toml 2>&1)
          echo "$OUTPUT"
          # Extract image ref from output
          IMAGE_REF=$(echo "$OUTPUT" | grep -oE 'registry\.fly\.io/[^[:space:]]+' | head -1)
          if [ -z "$IMAGE_REF" ]; then
            echo "Failed to extract image ref"
            exit 1
          fi
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          echo "Image ref: $IMAGE_REF"

      - name: Run crawler for Gaia
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-gaia-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.js\", \"--dc\", \"Gaia\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"

      - name: Run crawler for Mana
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-mana-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.js\", \"--dc\", \"Mana\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"

      - name: Run crawler for Elemental
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-elemental-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.js\", \"--dc\", \"Elemental\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"

      - name: Run crawler for Meteor
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-meteor-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.js\", \"--dc\", \"Meteor\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"
